/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var S=Object.defineProperty;var b=Object.getOwnPropertyDescriptor;var v=Object.getOwnPropertyNames;var E=Object.prototype.hasOwnProperty;var D=(c,n)=>{for(var e in n)S(c,e,{get:n[e],enumerable:!0})},x=(c,n,e,t)=>{if(n&&typeof n=="object"||typeof n=="function")for(let s of v(n))!E.call(c,s)&&s!==e&&S(c,s,{get:()=>n[s],enumerable:!(t=b(n,s))||t.enumerable});return c};var B=c=>x(S({},"__esModule",{value:!0}),c);var C={};D(C,{default:()=>y});module.exports=B(C);var i=require("obsidian");var g=require("obsidian"),w={backendUrl:"http://localhost:5000",autoCopy:!1,showFloatingButton:!0,defaultStyle:"paragraph",defaultLength:"medium",defaultLanguage:"zh"},p=class extends g.PluginSettingTab{constructor(n,e){super(n,e),this.plugin=e}display(){let{containerEl:n}=this;n.empty(),new g.Setting(n).setName("Backend URL").setDesc("The URL of the summarization backend API.").addText(e=>e.setPlaceholder("http://localhost:5000").setValue(this.plugin.settings.backendUrl).onChange(async t=>{this.plugin.settings.backendUrl=t,await this.plugin.saveSettings()})),new g.Setting(n).setName("Auto Copy").setDesc("Automatically copy selected text to clipboard.").addToggle(e=>e.setValue(this.plugin.settings.autoCopy).onChange(async t=>{this.plugin.settings.autoCopy=t,await this.plugin.saveSettings()})),new g.Setting(n).setName("Show Floating Button").setDesc("Show a floating button near the cursor when text is selected.").addToggle(e=>e.setValue(this.plugin.settings.showFloatingButton).onChange(async t=>{this.plugin.settings.showFloatingButton=t,await this.plugin.saveSettings()})),new g.Setting(n).setName("Default Summary Style").setDesc("The default style for the summary.").addDropdown(e=>e.addOption("paragraph","Paragraph").addOption("bullet","Bullet Points").addOption("concise","Concise").setValue(this.plugin.settings.defaultStyle).onChange(async t=>{this.plugin.settings.defaultStyle=t,await this.plugin.saveSettings()})),new g.Setting(n).setName("Default Summary Length").setDesc("The default length for the summary.").addDropdown(e=>e.addOption("short","Short").addOption("medium","Medium").addOption("long","Long").setValue(this.plugin.settings.defaultLength).onChange(async t=>{this.plugin.settings.defaultLength=t,await this.plugin.saveSettings()})),new g.Setting(n).setName("Default Language").setDesc("The default language for the summary.").addDropdown(e=>e.addOption("zh","Chinese").addOption("en","English").setValue(this.plugin.settings.defaultLanguage).onChange(async t=>{this.plugin.settings.defaultLanguage=t,await this.plugin.saveSettings()}))}};var y=class extends i.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new p(this.app,this)),this.createFloatingButton(),this.registerDomEvent(document,"selectionchange",this.handleSelectionChange.bind(this)),this.registerDomEvent(document,"mousedown",this.handleMouseDown.bind(this)),this.registerEvent(this.app.workspace.on("editor-change",this.handleEditorChange.bind(this))),this.addCommand({id:"summarize-selection",name:"Summarize Selection",editorCallback:(n,e)=>{let t=n.getSelection();t?new d(this.app,this,t).open():new i.Notice("No text selected.")}})}onunload(){this.floatingButton&&this.floatingButton.remove()}async loadSettings(){this.settings=Object.assign({},w,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}createFloatingButton(){this.floatingButton=document.body.createEl("div",{cls:"automatic-summary-floating-button"});let n=this.floatingButton.createEl("div",{cls:"automatic-summary-btn quick-btn"});(0,i.setIcon)(n,"zap"),n.setAttribute("aria-label","Quick Summarize (Use Defaults)"),n.addEventListener("click",t=>{var a;t.preventDefault(),t.stopPropagation();let s=(a=window.getSelection())==null?void 0:a.toString();s&&new d(this.app,this,s,!0).open()});let e=this.floatingButton.createEl("div",{cls:"automatic-summary-btn custom-btn"});(0,i.setIcon)(e,"settings"),e.setAttribute("aria-label","Custom Summarize"),e.addEventListener("click",t=>{var a;t.preventDefault(),t.stopPropagation();let s=(a=window.getSelection())==null?void 0:a.toString();s&&new d(this.app,this,s,!1).open()}),this.floatingButton.style.display="none"}handleMouseDown(n){(n.target===this.floatingButton||this.floatingButton.contains(n.target))&&n.preventDefault()}handleEditorChange(n,e){}handleSelectionChange(){let n=window.getSelection(),e=n==null?void 0:n.toString().trim();if(!e){this.hideFloatingButton();return}this.settings.autoCopy&&navigator.clipboard.writeText(e).catch(t=>{console.error("Failed to auto-copy:",t)}),this.settings.showFloatingButton&&this.showFloatingButton(n)}showFloatingButton(n){if(!this.floatingButton)return;let t=n.getRangeAt(0).getBoundingClientRect();if(t.width===0&&t.height===0){this.hideFloatingButton();return}let s=30,a=80,l=t.top-s-10,o=t.left+t.width/2-a/2;l<0&&(l=t.bottom+10),o<0&&(o=10),o+a>window.innerWidth&&(o=window.innerWidth-a-10),this.floatingButton.style.top=`${l+window.scrollY}px`,this.floatingButton.style.left=`${o+window.scrollX}px`,this.floatingButton.style.display="block"}hideFloatingButton(){this.floatingButton&&(this.floatingButton.style.display="none")}},d=class extends i.Modal{constructor(e,t,s,a=!1){super(e);this.messages=[];this.plugin=t,this.textToSummarize=s,this.quickSummary=a,this.options={style:t.settings.defaultStyle,length:t.settings.defaultLength,language:t.settings.defaultLanguage}}onOpen(){this.quickSummary?this.startSummarization():this.displayOptions()}displayOptions(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Summarize Options"});let t=e.createDiv({cls:"automatic-summary-options"});new i.Setting(t).setName("Summary Style").setDesc("Choose the format of the summary.").addDropdown(l=>l.addOption("paragraph","Paragraph").addOption("bullet","Bullet Points").addOption("concise","Concise").setValue(this.options.style).onChange(o=>this.options.style=o)),new i.Setting(t).setName("Summary Length").setDesc("Choose how long the summary should be.").addDropdown(l=>l.addOption("short","Short").addOption("medium","Medium").addOption("long","Long").setValue(this.options.length).onChange(o=>this.options.length=o)),new i.Setting(t).setName("Language").setDesc("Choose the output language.").addDropdown(l=>l.addOption("zh","Chinese").addOption("en","English").setValue(this.options.language).onChange(o=>this.options.language=o));let s=e.createDiv({cls:"modal-button-container"});s.style.marginTop="20px",s.createEl("button",{text:"Generate Summary",cls:"mod-cta"}).addEventListener("click",()=>{this.startSummarization()})}startSummarization(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Summary"});let t=e.createDiv({cls:"automatic-summary-loading"});t.createEl("span",{text:"Summarizing..."}),this.fetchSummary().then(s=>{t.remove(),this.displayResult(s)}).catch(s=>{t.remove(),this.displayError(s)})}async fetchSummary(){let e=this.plugin.settings,t=await(0,i.requestUrl)({url:`${e.backendUrl}/api/summarize`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:this.textToSummarize,options:{style:this.options.style,length:this.options.length,language:this.options.language}})});if(t.status!==200)throw new Error(`API Error: ${t.status}`);let s=t.json;return s.success&&s.data.messages&&(this.messages=s.data.messages),s}async refineSummary(e){let t=this.plugin.settings,s=await(0,i.requestUrl)({url:`${t.backendUrl}/api/refine`,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({messages:this.messages,prompt:e})});if(s.status!==200)throw new Error(`API Error: ${s.status}`);let a=s.json;return a.success&&a.data.messages&&(this.messages=a.data.messages),a}displayResult(e){let{contentEl:t}=this;if(t.empty(),t.createEl("h2",{text:"Summary Result"}),!e.success){this.displayError(e.error||"Unknown error");return}let s=t.createDiv({cls:"automatic-summary-chat-container"});if(this.messages&&this.messages.length>0)this.messages.forEach(r=>{if(r.role==="system")return;let u=s.createDiv({cls:`automatic-summary-message message-${r.role}`});u.createDiv({cls:"message-label"}).setText(r.role==="user"?"You":"AI"),u.createDiv({cls:"message-content"}).setText(r.content)});else{let r=e.data.summary,u=s.createDiv({cls:"automatic-summary-message message-assistant"});u.createDiv({cls:"message-label",text:"AI"}),u.createDiv({cls:"message-content",text:r})}let a=t.createDiv({cls:"automatic-summary-refine"}),l=a.createEl("textarea",{cls:"automatic-summary-refine-input",placeholder:"Ask AI to refine or change the summary..."}),o=a.createDiv({cls:"modal-button-container"});o.style.marginTop="10px",o.style.justifyContent="flex-end";let f=o.createEl("button",{text:"Send",cls:"mod-cta"});f.addEventListener("click",()=>{let r=l.value.trim();if(!r)return;let u=s.createDiv({cls:"automatic-summary-message message-user"});u.createDiv({cls:"message-label",text:"You"}),u.createDiv({cls:"message-content",text:r}),s.scrollTop=s.scrollHeight,l.disabled=!0,f.disabled=!0,f.setText("Thinking..."),this.refineSummary(r).then(m=>{this.displayResult(m)}).catch(m=>{this.displayError(m)})});let h=t.createDiv({cls:"modal-button-container"});h.style.marginTop="20px",h.style.borderTop="1px solid var(--background-modifier-border)",h.style.paddingTop="10px",h.createEl("button",{text:"Copy Latest Summary"}).addEventListener("click",()=>{var u;let r=this.messages?(u=[...this.messages].reverse().find(m=>m.role==="assistant"))==null?void 0:u.content:e.data.summary;r&&(navigator.clipboard.writeText(r),new i.Notice("Summary copied to clipboard!"))}),h.createEl("button",{text:"Back to Options"}).addEventListener("click",()=>{this.displayOptions()})}displayError(e){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Error"}),t.createDiv({cls:"automatic-summary-error",text:`Error: ${e}`});let s=t.createDiv({cls:"modal-button-container"});s.style.marginTop="10px",s.createEl("button",{text:"Try Again"}).addEventListener("click",()=>{this.displayOptions()})}onClose(){let{contentEl:e}=this;e.empty()}};
